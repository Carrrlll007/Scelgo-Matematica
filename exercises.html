<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MathHub – Esercizi</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Icone per il widget -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- MathJax per il rendering delle formule -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
</head>
<body>

  <header class="navbar">
    <div class="logo">Math<span>Hub</span></div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="about.html">About me</a>
      <a href="index.html#scelgomatematica">Mio Studio</a>
      <!-- Nuova struttura di navigazione con dropdown per Argomenti -->
      <div class="dropdown">
        <span class="dropbtn">Argomenti</span>
        <div class="dropdown-content">
          <!-- Livello 1: Scegli l'Argomento (Topics placeholder) -->
          <div class="dropdown-topic">
            <span class="topic-title">Analisi Matematica I</span>
            <div class="dropdown-submenu">
              <!-- Livello 2: Teoria ed Esercizi -->
              <a href="theory_analisi1.html">Teoria</a>
              <a href="exercises.html?topic=Analisi1">Esercizi</a>
            </div>
          </div>
          <div class="dropdown-topic">
            <span class="topic-title">Geometria Analitica</span>
            <div class="dropdown-submenu">
              <a href="theory_geometria.html">Teoria</a>
              <a href="exercises.html?topic=Geometria">Esercizi</a>
            </div>
          </div>
          <div class="dropdown-topic">
            <span class="topic-title">Algebra Lineare</span>
            <div class="dropdown-submenu">
              <a href="theory_algebra.html">Teoria</a>
              <a href="exercises.html?topic=Algebra">Esercizi</a>
            </div>
          </div>
          <a href="exercises.html">Math Agent</a> <!-- Link diretto al Math Agent -->
        </div>
      </div>
    </nav>
  </header>

  <section class="section section-light">
    <div class="container">
      <h2 id="page-title">Esercizi - Seleziona un Argomento</h2>

      <!-- Area per gli esercizi dell'utente, dinamica in base al topic -->
      <div id="exercise-content" class="exercise-area" contenteditable="false">
        <p>Seleziona un argomento dal menu "Argomenti" per visualizzare gli esercizi specifici, oppure usa il Math Agent per una domanda rapida!</p>
        
        <!-- ESEMPIO di contenuto di esercizio (sarà dinamico) -->
        <div id="example-exercise" style="padding: 20px; border: 1px dashed #ccc; margin-top: 20px; border-radius: 8px; background: #f9f9f9;">
            <h3>Esempio di Esercizio: Integrali</h3>
            <p>Calcola il seguente integrale definito:</p>
            $$ \int_{0}^{1} x e^{x} \,dx $$
            <p><strong>La mia Soluzione:</strong> <span style="color: green;">La soluzione è $1$. (Usa l'integrazione per parti).</span></p>
        </div>

      </div>
    </div>
  </section>

  <!-- MATH AGENT WIDGET (Fisso in basso a destra) -->
  <div id="mini-agent-widget">
    <div id="agent-icon" onclick="toggleMiniChat()">
      <i class="fas fa-robot"></i>
    </div>
    <div id="mini-chat-box">
      <div id="chat-header">
        Math Agent
        <span onclick="toggleMiniChat()">&times;</span>
      </div>
      <div id="chat-body">
        <div class="chat-message bot-message">Ciao! Chiedimi pure qualsiasi esercizio o concetto di matematica.</div>
      </div>
      <div id="chat-footer">
        <input type="text" id="mini-agent-input" placeholder="Chiedi al tuo assistente..." />
        <button onclick="sendMiniChat()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>


  <script>
    // --- Funzionalità di base del Math Agent ---

    // 1. Funzione per l'API (Simulazione / Placeholder)
    async function callMathAgent(prompt, mode, image, history) {
        // Simula un ritardo di rete
        await new Promise(resolve => setTimeout(resolve, 1500)); 

        const questionLower = prompt.toLowerCase();
        let answer = "Mi scuso, ma la funzione API al momento è simulata. Ecco un esempio di risposta matematica: Ricorda che il Teorema di Pitagora afferma che in un triangolo rettangolo $a^2 + b^2 = c^2$.";

        if (questionLower.includes("risolvi") || questionLower.includes("calcola")) {
            answer = "Sto processando la tua richiesta... Per l'esercizio di prova: $\\int_{0}^{1} x e^{x} \,dx$. Usando l'integrazione per parti $\\int u dv = uv - \\int v du$: Sia $u=x$ e $dv=e^x dx$. Allora $du=dx$ e $v=e^x$. La soluzione è: $[xe^x]_0^1 - [e^x]_0^1 = (e-0) - (e-1) = 1$.";
        } else if (questionLower.includes("funzione") || questionLower.includes("teoria")) {
            answer = "Certo! Una funzione $f: A \\to B$ associa ad ogni elemento di $A$ uno e un solo elemento di $B$. Ad esempio, $f(x) = x^2$ è una funzione che mappa i numeri reali a numeri reali non negativi.";
        }
        
        // Aggiunge la formattazione Latex
        return answer;
    }


    // 2. Funzionalità Chat
    const miniChatBox = document.getElementById("mini-chat-box");
    function toggleMiniChat() {
        miniChatBox.classList.toggle('open');
        const icon = document.getElementById("agent-icon");
        icon.classList.toggle('active');
    }

    async function sendMiniChat() {
        const input = document.getElementById("mini-agent-input");
        const body = document.getElementById("chat-body");
        const question = input.value.trim();
        
        if (!question) return;

        // Aggiungi messaggio utente
        body.innerHTML += `<div class="chat-message user-message">${question}</div>`;
        input.value = "";
        body.scrollTop = body.scrollHeight; // Scroll to bottom

        // Messaggio di attesa
        const loadingId = "loading-" + Date.now();
        body.innerHTML += `<div class="chat-message bot-message" id="${loadingId}">...</div>`;
        
        // Chiamata API (Simulata, usa null per i parametri non necessari)
        const answer = await callMathAgent(question, null, null, null);
        
        // Rimuovi loading e metti risposta
        const loadingDiv = document.getElementById(loadingId);
        loadingDiv.innerHTML = answer;
        
        // Rerender MathJax nella mini chat
        if (typeof MathJax !== 'undefined') MathJax.typesetPromise([loadingDiv]);
        
        body.scrollTop = body.scrollHeight;
    }

    // Permette di inviare con "Invio" nella mini chat
    document.getElementById("mini-agent-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // Impedisce il submit del form (se fosse un form)
            sendMiniChat();
        }
    });


    // 3. Gestione Contenuto Esercizi in base al Topic
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const topic = urlParams.get('topic');
        const titleElement = document.getElementById('page-title');
        const contentElement = document.getElementById('exercise-content');
        
        if (topic) {
            const displayTopic = decodeURIComponent(topic.replace(/\+/g, ' '));
            titleElement.textContent = `Esercizi - ${displayTopic}`;
            contentElement.innerHTML = `
                <h3>Esercizi per ${displayTopic}</h3>
                <p>Qui troverai la tua raccolta di esercizi per l'argomento <strong>${displayTopic}</strong>.</p>
                <div class="exercise-card">
                    <h4>Esercizio 1: ${displayTopic}</h4>
                    <p>Inserisci qui un problema specifico. Ad esempio, se l'argomento è 'Analisi1': Calcola la derivata di $f(x) = x \\sin(x)$.</p>
                    <p><strong>La tua Soluzione:</strong> <span style="color: blue;">(La soluzione è $f'(x) = \\sin(x) + x \\cos(x)$)</span></p>
                </div>
                <div class="exercise-card">
                    <h4>Esercizio 2: ${displayTopic}</h4>
                    <p>Inserisci un altro problema qui...</p>
                    <p><strong>La tua Soluzione:</strong></p>
                </div>
            `;
            // Assicurati che MathJax renderizzi il nuovo contenuto
            if (typeof MathJax !== 'undefined') MathJax.typesetPromise([contentElement]);
        } else {
             // Nessun topic selezionato, usa il contenuto di default
             titleElement.textContent = "Esercizi e Math Agent";
        }
    });

    // --- Funzionalità di Editing (Client-Side) ---
    // Simula l'identificazione dell'Editor: Solo se il token è presente
    const isEditor = typeof __initial_auth_token !== 'undefined' && __initial_auth_token.length > 0;

    // Se l'utente è l'editor, mostra il pulsante e abilita l'editing
    if (isEditor) {
      document.addEventListener('DOMContentLoaded', () => {
        const nav = document.querySelector('.nav-links');
        const editButton = document.createElement('button');
        editButton.textContent = 'Abilita Editing';
        editButton.id = 'edit-toggle';
        editButton.className = 'editor-button';
        
        // Aggiunge il pulsante al lato sinistro dei link di navigazione
        const editContainer = document.createElement('div');
        editContainer.className = 'edit-container';
        editContainer.appendChild(editButton);
        nav.parentElement.insertBefore(editContainer, nav);


        let editingMode = false;
        
        // Seleziona tutti gli elementi che possono essere modificati in questa pagina
        const editableElements = document.querySelectorAll('#page-title, #exercise-content');
        
        // Imposta tutti gli elementi a contenteditable="false" inizialmente per sicurezza
        editableElements.forEach(el => el.setAttribute('contenteditable', 'false'));
        
        editButton.addEventListener('click', () => {
          editingMode = !editingMode;
          
          if (editingMode) {
            editButton.textContent = 'Salva Modifiche (Solo Locale)';
            editButton.classList.add('active');
            editableElements.forEach(el => {
              el.setAttribute('contenteditable', 'true');
              el.classList.add('editable-active');
            });
            alert('Modalità di Editing Attivata. Le modifiche sono salvate localmente per questa sessione. Per renderle permanenti (non implementato), sarebbe necessaria una connessione al server/database.');
          } else {
            editButton.textContent = 'Abilita Editing';
            editButton.classList.remove('active');
            editableElements.forEach(el => {
              el.setAttribute('contenteditable', 'false');
              el.classList.remove('editable-active');
            });
            alert('Modalità di Editing Disattivata.');
          }
        });
      });
    }
  </script>
</body>
</html>